<!DOCTYPE html>
<html>
  <head>
    <title>Gallery</title>
    <style>
      .gallery {
        display: flex;
        flex-wrap: wrap;
      }
      .gallery img {
        width: 200px;
        height: 200px;
        object-fit: cover;
        margin: 5px;
        border-radius: 5px;
        cursor: pointer;
      }
      .gallery img.active {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: contain;
        z-index: 1;
      }
    </style>
  </head>
  <body>
    <div class="gallery">
      <img src="https://placekitten.com/200/200" alt="Image 1" />
      <img src="https://placekitten.com/200/201" alt="Image 2" />
      <img src="https://placekitten.com/200/202" alt="Image 3" />
    </div>

    <script>
      const gallery = document.querySelector(".gallery")
      const images = gallery.querySelectorAll("img")
      const params = new URLSearchParams(window.location.search)

      if (params.has("image")) {
        const index = parseInt(params.get("image"))
        if (!isNaN(index)) {
          openImage(index)
        }
      }

      function openImage(index) {
        images[index].classList.add("active")
        history.pushState({ imageIndex: index }, "", "")
        window.addEventListener("popstate", onPopState)
        window.addEventListener("click", onClickOutside)
      }

      function closeImage() {
        const activeImage = gallery.querySelector(".active")
        const index = Array.from(images).indexOf(activeImage)
        activeImage.classList.remove("active")
        history.pushState({ imageIndex: null }, "", "")
        window.removeEventListener("popstate", onPopState)
        window.removeEventListener("click", onClickOutside)
      }

      function onPopState() {
        const index = history.state?.imageIndex
        if (index !== undefined && index !== null) {
          openImage(index)
        } else {
          closeImage()
        }
      }

      images.forEach((image, index) => {
        image.addEventListener("click", () => openImage(index))

        const linkButton = document.createElement("button")
        linkButton.textContent = "Link"

        linkButton.addEventListener("click", (event) => {
          event.stopPropagation()
          const url = new URL(window.location.href)
          url.searchParams.set("image", index)
          prompt("Copy this link:", url.toString())
        })

        image.after(linkButton)
      })

      const closeButton = document.createElement("button")
      closeButton.textContent = "Close"
      closeButton.addEventListener("click", closeImage)
      closeButton.style.position = "fixed"
      closeButton.style.top = "10px"
      closeButton.style.right = "10px"
      closeButton.style.zIndex = "2"

      function onImageClick(event) {
        const image = event.target
        image.classList.add("active")
        image.after(closeButton)
        window.addEventListener("click", onClickOutside)
      }

      function onClickOutside(event) {
        const activeImage = gallery.querySelector(".active")
        if (activeImage && !activeImage.contains(event.target)) {
          activeImage.classList.remove("active")
          closeButton.remove()
          window.removeEventListener("click", onClickOutside)
        }
      }

      images.forEach((image) => {
        image.addEventListener("click", onImageClick)
      })
    </script>
  </body>
</html>
