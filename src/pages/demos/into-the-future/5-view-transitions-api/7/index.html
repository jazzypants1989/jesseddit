<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Animated Image Gallery</title>
    <style>
      body {
        margin: 0;
      }

      #gallery {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        background: #000;
      }

      .gallery-item {
        width: 200px;
        height: 200px;
        cursor: pointer;
        overflow: hidden;
      }

      .gallery-item img {
        width: 100%;
        height: 100%;
        object-fit: contain;
      }

      .gallery-item.active {
        position: absolute;
        width: fit-content;
        height: fit-content;
        max-width: 100%;
        max-height: 100%;
        object-fit: cover;
      }

      /* ::view-transition-group(gallery-item-transition-0) {
        animation-duration: 2s;
      } */
    </style>
  </head>
  <body>
    <div id="gallery"></div>
    <script>
      const gallery = document.querySelector("#gallery")
      const root = document.documentElement

      // Adapted from https://stackoverflow.com/questions/4481485/changing-css-pseudo-element-styles-via-javascript
      // This IIFE adds a rule to the document's stylesheet
      // We're using it because we can't adjust the pseudo-elements directly with JS
      const addRule = ((style) => {
        const sheet = document.head.appendChild(style).sheet
        return (selector, css) => {
          const propText =
            typeof css === "string"
              ? css
              : Object.keys(css)
                  .map(function (p) {
                    return (
                      p + ":" + (p === "content" ? "'" + css[p] + "'" : css[p])
                    )
                  })
                  .join(";")
          return sheet.insertRule(
            selector + "{" + propText + "}",
            sheet.cssRules.length
          )
        }
      })(document.createElement("style"))

      const images = [
        "https://placekitten.com/200/200",
        "https://placekitten.com/300/300",
        "https://placekitten.com/400/400",
        "https://placekitten.com/500/500",
        "https://placekitten.com/600/600",
        "https://placekitten.com/700/700",
        "https://placekitten.com/800/800",
        "https://placekitten.com/900/900",
      ]

      images.forEach((src) => {
        const item = document.createElement("div")
        item.classList.add("gallery-item")
        const img = document.createElement("img")
        img.src = src
        img.alt = "cute kitten"
        item.appendChild(img)
        gallery.appendChild(item)
      })

      const galleryItems = document.querySelectorAll(".gallery-item")

      galleryItems.forEach((item, index) => {
        item.style.setProperty(
          "view-transition-name",
          `gallery-item-transition-${index}`
        )

        addRule(`::view-transition-old(gallery-item-transition-${index})`, {
          opacity: 0,
        })

        // This does nothing, LOL. Maybe soon?
        addRule(`::view-transition-group(gallery-item-transition-${index})`, {
          animationDuration: "10s",
        })

        item.addEventListener("click", () => {
          transitionHelper({
            updateDOM: () => {
              if (!item.classList.contains("active")) {
                item.classList.add("active")
                document
                  .querySelectorAll(".gallery-item:not(.active)")
                  .forEach((item) => {
                    item.style.display = "none"
                  })
              } else {
                item.classList.remove("active")
                galleryItems.forEach((item) => {
                  item.style.display = "block"
                })
              }
            },
          })
        })
      })

      function transitionHelper({ updateDOM }) {
        if (!document.startViewTransition) {
          const updateCallbackDone = Promise.resolve(updateDOM())

          return {
            ready: Promise.reject(Error("View transitions unsupported")),
            updateCallbackDone,
            finished: updateCallbackDone,
          }
        }

        const transition = document.startViewTransition(updateDOM)

        return transition
      }
    </script>
  </body>
</html>
